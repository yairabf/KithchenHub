name: Deploy to Staging

on:
  push:
    branches:
      - develop
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-staging.yml'
      - '.github/workflows/_deploy.yml'

concurrency:
  group: deploy-staging-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy_to_staging:
    name: Deploy to staging environment
    uses: ./.github/workflows/_deploy.yml
    with:
      environment: staging
      deploy_target: gcp-cloudrun
      image_tag: develop-latest
      # Health checks are optional. If STAGING_SERVICE_URL is unset, checks are skipped.
      service_url: ${{ secrets.STAGING_SERVICE_URL }}
    # Required for Cloud Run: GCP_PROJECT_ID, GCP_REGION, GCP_CLOUD_RUN_SERVICE_STAGING, GCP_SA_KEY. See backend/DEPLOYMENT.md.
    secrets:
      DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
      DIRECT_URL: ${{ secrets.STAGING_DIRECT_URL }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_REGION: ${{ secrets.GCP_REGION }}
      GCP_CLOUD_RUN_SERVICE: ${{ secrets.GCP_CLOUD_RUN_SERVICE_STAGING }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
