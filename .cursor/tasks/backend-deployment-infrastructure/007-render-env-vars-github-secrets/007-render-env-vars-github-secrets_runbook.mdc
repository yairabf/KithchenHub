# 007 - Render Env Vars + GitHub Secrets - Runbook

## Scope

This runbook is the **manual execution** companion to `007-render-env-vars-github-secrets_plan.mdc`.

It’s written so you can configure Render + GitHub without ever placing secrets in the repo.

---

## 1) Render: Staging service (Docker image from GHCR)

### Service create

- **New → Web Service → Existing Image**
- **Image**: `ghcr.io/<github_owner>/kitchen-hub-api:develop-latest`
- **Environment**: Docker
- **Auto-deploy**: disable (deployments triggered via deploy hook)
- **Port**: 3000
- **Health Check Path**: `/api/version`

### GHCR auth (only if package is private)

- Create GitHub PAT (classic) with **`read:packages`**
- In Render, set registry credentials for GHCR:
  - **Username**: your GitHub username / org name
  - **Password**: the PAT

### Environment variables (Render → Environment)

**Required**

- `NODE_ENV=production`
- `DATABASE_URL=<staging pooled/normal postgres url>`
- `DIRECT_URL=<staging direct postgres url>`
- `JWT_SECRET=<generate (32+ chars)>`
- `JWT_REFRESH_SECRET=<generate (32+ chars)>`
- `SUPABASE_URL=<staging/prod supabase project url>`
- `SUPABASE_ANON_KEY=<supabase anon key>`

**Recommended**

- `SUPABASE_SERVICE_ROLE_KEY=<supabase service role key>` (treat as secret)

**Optional**

- `JWT_EXPIRES_IN=15m`
- `JWT_REFRESH_EXPIRES_IN=7d`
- `GOOGLE_CLIENT_ID=...` / `GOOGLE_CLIENT_SECRET=...` (only if using Google sign-in)

### Deploy hook (Render → Settings → Deploy Hook)

- Copy the generated deploy hook URL
- Save it for GitHub Secret: `RENDER_DEPLOY_HOOK_URL_STAGING`

---

## 2) Render: Production service (Docker image from GHCR)

Same as staging, with:

- **Image**: `ghcr.io/<github_owner>/kitchen-hub-api:main-latest`
- **JWT secrets must differ from staging**
- **Deploy hook** saved as: `RENDER_DEPLOY_HOOK_URL_PRODUCTION`

---

## 3) GitHub Actions: Required repository/environment secrets

### Required to deploy (Render deploy hooks)

- `RENDER_DEPLOY_HOOK_URL_STAGING` = (staging Render deploy hook URL)
- `RENDER_DEPLOY_HOOK_URL_PRODUCTION` = (production Render deploy hook URL)

### Required to run migrations in CI (at least one per env)

The deploy workflow runs Prisma migrations in GitHub Actions before triggering Render.

**Staging**
- `STAGING_DIRECT_URL` (preferred)
- `STAGING_DATABASE_URL` (fallback)

**Production**
- `PROD_DIRECT_URL` (preferred)
- `PROD_DATABASE_URL` (fallback)

### Optional: enable health checks (set these and health checks will run automatically)

Because we wired `service_url` to secrets, setting these secrets enables checks without code changes:

- `STAGING_SERVICE_URL` = e.g. `https://kitchen-hub-api-staging.onrender.com`
- `PRODUCTION_SERVICE_URL` = e.g. `https://kitchen-hub-api-production.onrender.com`

---

## 4) GitHub Environment: `production` approval gate

Repo → Settings → Environments → **New environment** → `production`

- Enable **Required reviewers**
- Restrict deployment branches to **main**
- Optionally move production secrets to environment-scoped secrets

---

## 5) JWT secret generation (copy/paste)

Generate two independent secrets for each environment:

```bash
openssl rand -base64 32
openssl rand -base64 32
```

---

## 6) Verification checklist

### Repo-side (no secrets committed)

- Run:

```bash
bash scripts/check-secret-hygiene.sh
```

### Staging deploy

- Push a trivial change to `develop`
- Expect in GitHub Actions:
  - `build.yml` pushes `develop-latest`
  - `deploy-staging.yml` runs migrations and triggers Render deploy hook

### Production deploy

- Push to `main`
- Expect:
  - approval gate
  - migrations
  - Render deploy hook triggers deployment

