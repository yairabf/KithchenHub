# 007 - Render Env Vars + GitHub Secrets

**Epic:** Backend Deployment Infrastructure  
**Created:** 2026-01-29  
**Status:** In Progress

## Purpose of this file

This task documents the **exact configuration** required to run Kitchen Hub backend deployments end-to-end:

- **Render**: runtime environment variables for **staging** and **production** services
- **GitHub**: required **Actions secrets** (deploy hooks + DB URLs for migrations)
- **GitHub Environments**: manual approval gate for production deploys

This is intentionally “operations-first”: it’s designed to be followed step-by-step without committing any secrets.

## Current status (repo audit)

### Implemented in-repo ✅

- **Build to GHCR**: `/.github/workflows/build.yml` builds and pushes images for `develop` + `main`.
- **Deploy workflows**:
  - `/.github/workflows/deploy-staging.yml` (caller)
  - `/.github/workflows/deploy-production.yml` (caller w/ `environment: production`)
  - `/.github/workflows/_deploy.yml` (reusable workflow: migrations → deploy → optional health check)
- **Backend env validation**: `/backend/src/config/env.validation.ts`
- **Secret files ignored**: root `/.gitignore` ignores `.env*`; backend `/backend/.gitignore` ignores `.env` and allows example templates.

### Not yet configured (external systems) ❌

- **Render services** (staging + production) are not created/configured in Render.
- **Deploy hooks are not in GitHub Secrets** (they don’t exist until services exist).
- **DB URLs for migrations are not in GitHub Secrets**.
- **GitHub Environment `production` may not be configured** (reviewers/branch restriction).

## Authoritative env var list (what the backend actually expects)

### Render service environment variables (set in Render dashboard)

From `/backend/src/config/env.validation.ts` plus Prisma `directUrl` requirement (`DIRECT_URL`) in `/backend/src/infrastructure/database/prisma/schema.prisma`:

- **Required (staging + production)**
  - `NODE_ENV=production`
  - `DATABASE_URL` (pooled/normal connection; used at runtime)
  - `DIRECT_URL` (direct DB connection; required by Prisma schema; recommended for migrations)
  - `JWT_SECRET` (min 32 chars)
  - `JWT_REFRESH_SECRET` (min 32 chars)
  - `SUPABASE_URL`
  - `SUPABASE_ANON_KEY`
- **Optional (staging + production)**
  - `JWT_EXPIRES_IN` (default `15m`)
  - `JWT_REFRESH_EXPIRES_IN` (default `7d`)
  - `SUPABASE_SERVICE_ROLE_KEY` (recommended for backend; treat as secret)
  - `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` (only if Google sign-in is used)

### Port notes for Render

- Render sets PORT=10000 by default. Do not override in Render; app binds to process.env.PORT on 0.0.0.0. Local dev defaults to 3000 in env validation.
- In Render, do not set the service “Port” to **3000**. Render may also inject `PORT` automatically.

## GitHub Secrets required by deploy workflows

### Required for Render deploy trigger

- `RENDER_DEPLOY_HOOK_URL_STAGING`
- `RENDER_DEPLOY_HOOK_URL_PRODUCTION`

### Required for migrations (CI) — per environment

The reusable deploy workflow needs **at least one** DB URL for migrations.

- **Staging**: `STAGING_DIRECT_URL` (preferred) and/or `STAGING_DATABASE_URL`
- **Production**: `PROD_DIRECT_URL` (preferred) and/or `PROD_DATABASE_URL`

### Optional for post-deploy health checks

- `STAGING_SERVICE_URL` (e.g. `https://kitchen-hub-api-staging.onrender.com`)
- `PRODUCTION_SERVICE_URL` (e.g. `https://kitchen-hub-api-production.onrender.com`)

## Render setup checklist (staging + production)

### Staging service

- **Service type**: Web Service → Existing Image
- **Image**: `ghcr.io/<owner>/kitchen-hub-api:develop-latest`
- **Auto-deploy**: disabled (deployments triggered via deploy hook)
- **Health check path**: `/api/version` (no trailing slash; returns 200)
- **Port**: Leave Render default (10000); app uses `process.env.PORT`
- **Env vars**: set all required vars above (staging values)
- **Deploy hook**: create/copy URL from Render → Settings → Deploy Hook

### Production service

- **Image**: `ghcr.io/<owner>/kitchen-hub-api:main-latest`
- **JWT secrets**: MUST be different from staging
- Same health check + port + env var requirements as staging
- **Deploy hook**: create/copy URL

### GHCR image pull credentials (Render)

If the GHCR package is private, Render needs GitHub Container Registry credentials:

- Create a GitHub PAT with **`read:packages`**
- Configure it in Render as the registry credential for GHCR

## GitHub setup checklist

### Secrets

Add the secrets listed above under GitHub → Repo → Settings → Secrets and variables → Actions.

### Production Environment gate

GitHub → Repo → Settings → Environments → create `production`:

- **Required reviewers**: enable
- **Deployment branches**: restrict to `main`
- (Optional) store production-only secrets at environment scope instead of repo scope

## Validation runbook

### Staging

- Push a trivial change to `develop` (or run workflow manually if enabled).
- Expected: `build.yml` pushes `develop-latest` → deploy workflow runs migrations → triggers Render deploy hook.

### Production

- Push to `main` (or run “Deploy to Production” with `workflow_dispatch`).
- Expected: approval gate → migrations → Render deploy hook.

## Secret hygiene checklist

- No real secrets in repo files (only example templates).
- No tracked `.env` files.
- GitHub + Render hold the real values.

