# 006 - Render Setup: Connect Repo + Create Staging/Prod Services

**Epic:** Backend Deployment Infrastructure  
**Created:** 2026-01-28  
**Status:** Planning

## Overview

Set up Render account, connect GitHub repository, and configure Docker-based services for staging and production environments. This includes configuring health check paths, deploy hooks, and image pull settings from GitHub Container Registry (GHCR).

## Current Status Analysis

### Already Implemented ✅

1. **Docker Infrastructure**:
   - Production-ready multi-stage Dockerfile exists at `backend/Dockerfile`
   - Images automatically built and pushed to GHCR via GitHub Actions
   - Image naming: `ghcr.io/${{ github.repository_owner }}/kitchen-hub-api:TAG`
   - Tagging strategy: `develop-latest`, `main-latest`, `BRANCH-SHA`

2. **GitHub Actions Workflows**:
   - `build.yml` - Builds and pushes images to GHCR for `develop` and `main` branches
   - `build-push.yml` - Builds images for all branches
   - `_deploy.yml` - Reusable deployment workflow supporting Render, AWS ECS, GCP Cloud Run
   - `deploy-staging.yml` - Staging deployment workflow (triggers on `develop` branch)
   - `deploy-production.yml` - Production deployment workflow (triggers on `main` branch with approval)

3. **Health Check Endpoint**:
   - `/api/version` endpoint exists and is public (no authentication required)
   - Returns API version information
   - Used by deployment workflows for health checks

4. **Deployment Documentation**:
   - `backend/DEPLOYMENT.md` contains Render setup instructions
   - `backend/docs/GHCR_QUICK_REFERENCE.md` documents GHCR usage
   - Workflow documentation exists in plan files

### What's Missing ❌

1. **Render Account Setup**: No Render account configured
2. **GitHub Repository Connection**: Repository not connected to Render
3. **Render Services**: No staging or production services created in Render
4. **Service Configuration**:
   - Docker image pull from GHCR not configured
   - Health check path not configured
   - Deploy hooks not created/configured
   - GHCR authentication credentials not set up
   - Environment variables not configured in Render
5. **GitHub Secrets**: Deploy hook URLs not yet available (will be created after services are set up)

## Architecture

### Render Service Architecture

```mermaid
graph TB
    A[GitHub Repository] -->|Connected| B[Render Dashboard]
    B --> C[Staging Service]
    B --> D[Production Service]
    
    C -->|Pulls Image| E[GHCR: develop-latest]
    D -->|Pulls Image| F[GHCR: main-latest]
    
    C -->|Health Check| G[/api/version]
    D -->|Health Check| G
    
    H[GitHub Actions] -->|Deploy Hook| C
    H -->|Deploy Hook| D
    
    C -->|Environment Vars| I[Staging Database]
    D -->|Environment Vars| J[Production Database]
```

### Service Configuration Requirements

**Staging Service:**
- **Type**: Web Service
- **Image Source**: GitHub Container Registry (GHCR)
- **Image URL**: `ghcr.io/YOUR_GITHUB_USERNAME/kitchen-hub-api:develop-latest`
- **Health Check Path**: `/api/version`
- **Deploy Hook**: Auto-generated by Render (to be added to GitHub secrets)
- **Environment**: Staging-specific variables

**Production Service:**
- **Type**: Web Service
- **Image Source**: GitHub Container Registry (GHCR)
- **Image URL**: `ghcr.io/YOUR_GITHUB_USERNAME/kitchen-hub-api:main-latest`
- **Health Check Path**: `/api/version`
- **Deploy Hook**: Auto-generated by Render (to be added to GitHub secrets)
- **Environment**: Production-specific variables

## Implementation Steps

### Step 1: Create Render Account

**Location**: [Render Dashboard](https://dashboard.render.com)

1. **Sign Up/Login**:
   - Go to https://dashboard.render.com
   - Sign up for a new account or log in to existing account
   - Verify email if required

2. **Account Verification**:
   - Complete account setup
   - Choose appropriate plan (Free tier available for testing)
   - Note: Free tier has limitations (sleeps after inactivity, limited resources)

### Step 2: Connect GitHub Repository

**Location**: Render Dashboard → Account Settings → Connected Accounts

1. **Connect GitHub Account**:
   - Navigate to Account Settings → Connected Accounts
   - Click "Connect GitHub" or "Connect Account"
   - Authorize Render to access GitHub repositories
   - Select appropriate permissions:
     - ✅ Read repository contents
     - ✅ Read package registry (for GHCR access)

2. **Verify Connection**:
   - Confirm repository appears in Render dashboard
   - Verify repository access permissions

### Step 3: Create GitHub Personal Access Token for GHCR

**Location**: GitHub Settings → Developer settings → Personal access tokens

1. **Generate Token**:
   - Go to GitHub Settings → Developer settings → Personal access tokens → Tokens (classic)
   - Click "Generate new token (classic)"
   - Name: "Render GHCR Access"
   - Select scopes:
     - ✅ `read:packages` (required to pull images from GHCR)
   - Click "Generate token"
   - **Copy token immediately** (won't be visible again)

2. **Store Token Securely**:
   - Keep token safe for use in Render service configuration
   - Token will be used as GHCR password in Render

### Step 4: Create Staging Service

**Location**: Render Dashboard → New → Web Service

1. **Service Creation**:
   - Click "+ New" → "Web Service"
   - Under "Source Code", select "Existing Image"
   - Image URL: `ghcr.io/YOUR_GITHUB_USERNAME/kitchen-hub-api:develop-latest`
     - Replace `YOUR_GITHUB_USERNAME` with actual GitHub username/organization

2. **Configure Image Pull**:
   - Registry: Select "GitHub Container Registry"
   - Username: Enter GitHub username
   - Password: Enter GitHub Personal Access Token (from Step 3)
   - Click "Add credential" or "Save credential"

3. **Service Settings**:
   - **Name**: `kitchen-hub-api-staging` (or similar)
   - **Region**: Choose appropriate region (e.g., US East)
   - **Branch**: Not applicable (using Docker image)
   - **Root Directory**: Not applicable (using Docker image)
   - **Environment**: `Docker`
   - **Dockerfile Path**: Not applicable (using pre-built image)
   - **Docker Command**: Leave default (image has CMD defined)
   - **Instance Type**: Choose based on needs (Free tier available)

4. **Health Check Configuration**:
   - **Health Check Path**: `/api/version`
   - **Health Check Interval**: Default (30 seconds)
   - **Health Check Timeout**: Default (10 seconds)
   - **Health Check Grace Period**: Default (40 seconds)

5. **Environment Variables**:
   - Add staging-specific environment variables:
     - `NODE_ENV=production`
     - `PORT=3000` (or Render's assigned port)
     - `DATABASE_URL` (staging database connection string)
     - `DIRECT_URL` (staging direct database connection string)
     - `JWT_SECRET` (staging JWT secret)
     - `JWT_REFRESH_SECRET` (staging refresh token secret)
     - `SUPABASE_URL` (Supabase project URL)
     - `SUPABASE_ANON_KEY` (Supabase anonymous key)
     - `SUPABASE_SERVICE_ROLE_KEY` (Supabase service role key)
     - Other required variables from `backend/src/config/env.validation.ts`

6. **Deploy Hook Configuration**:
   - Navigate to Settings → Deploy Hook
   - Copy the deploy hook URL (format: `https://api.render.com/deploy/srv-xxx?key=yyy`)
   - **Save this URL** - will be added to GitHub secrets in Step 6

7. **Auto-Deploy Settings**:
   - **Auto-Deploy**: Disable (deployments triggered via GitHub Actions)
   - Manual deployments or deploy hook triggers only

8. **Create Service**:
   - Review all settings
   - Click "Create Web Service"
   - Wait for initial deployment to complete

### Step 5: Create Production Service

**Location**: Render Dashboard → New → Web Service

1. **Service Creation**:
   - Click "+ New" → "Web Service"
   - Under "Source Code", select "Existing Image"
   - Image URL: `ghcr.io/YOUR_GITHUB_USERNAME/kitchen-hub-api:main-latest`
     - Replace `YOUR_GITHUB_USERNAME` with actual GitHub username/organization

2. **Configure Image Pull**:
   - Registry: Select "GitHub Container Registry"
   - Username: Enter GitHub username
   - Password: Enter GitHub Personal Access Token (from Step 3)
   - Can reuse credential from staging service if same token

3. **Service Settings**:
   - **Name**: `kitchen-hub-api-production` (or similar)
   - **Region**: Choose appropriate region (should match staging or production requirements)
   - **Branch**: Not applicable (using Docker image)
   - **Root Directory**: Not applicable (using Docker image)
   - **Environment**: `Docker`
   - **Dockerfile Path**: Not applicable (using pre-built image)
   - **Docker Command**: Leave default (image has CMD defined)
   - **Instance Type**: Choose production-appropriate instance (not Free tier)

4. **Health Check Configuration**:
   - **Health Check Path**: `/api/version`
   - **Health Check Interval**: Default (30 seconds)
   - **Health Check Timeout**: Default (10 seconds)
   - **Health Check Grace Period**: Default (40 seconds)

5. **Environment Variables**:
   - Add production-specific environment variables:
     - `NODE_ENV=production`
     - `PORT=3000` (or Render's assigned port)
     - `DATABASE_URL` (production database connection string)
     - `DIRECT_URL` (production direct database connection string)
     - `JWT_SECRET` (production JWT secret - different from staging)
     - `JWT_REFRESH_SECRET` (production refresh token secret - different from staging)
     - `SUPABASE_URL` (Supabase project URL)
     - `SUPABASE_ANON_KEY` (Supabase anonymous key)
     - `SUPABASE_SERVICE_ROLE_KEY` (Supabase service role key)
     - Other required variables from `backend/src/config/env.validation.ts`

6. **Deploy Hook Configuration**:
   - Navigate to Settings → Deploy Hook
   - Copy the deploy hook URL (format: `https://api.render.com/deploy/srv-xxx?key=yyy`)
   - **Save this URL** - will be added to GitHub secrets in Step 6

7. **Auto-Deploy Settings**:
   - **Auto-Deploy**: Disable (deployments triggered via GitHub Actions)
   - Manual deployments or deploy hook triggers only

8. **Create Service**:
   - Review all settings
   - Click "Create Web Service"
   - Wait for initial deployment to complete

### Step 6: Configure GitHub Secrets

**Location**: GitHub Repository → Settings → Secrets and variables → Actions

1. **Add Staging Deploy Hook Secret**:
   - Name: `RENDER_DEPLOY_HOOK_URL_STAGING`
   - Value: Deploy hook URL from staging service (Step 4.6)
   - Click "Add secret"

2. **Add Production Deploy Hook Secret**:
   - Name: `RENDER_DEPLOY_HOOK_URL_PRODUCTION`
   - Value: Deploy hook URL from production service (Step 5.6)
   - Click "Add secret"

3. **Add Database Secrets (Optional, for migrations)**:
   - `STAGING_DATABASE_URL` (if using automated migrations)
   - `STAGING_DIRECT_URL` (preferred for migrations)
   - `PROD_DATABASE_URL` (if using automated migrations)
   - `PROD_DIRECT_URL` (preferred for migrations)

4. **Add Service URL Secrets (Optional, for health checks)**:
   - `STAGING_SERVICE_URL` (e.g., `https://kitchen-hub-api-staging.onrender.com`)
   - `PRODUCTION_SERVICE_URL` (e.g., `https://kitchen-hub-api-production.onrender.com`)

### Step 7: Verify Service Configuration

1. **Verify Staging Service**:
   - Check service is running in Render dashboard
   - Test health endpoint: `https://YOUR_STAGING_URL.onrender.com/api/version`
   - Verify environment variables are set correctly
   - Check logs for any startup errors

2. **Verify Production Service**:
   - Check service is running in Render dashboard
   - Test health endpoint: `https://YOUR_PRODUCTION_URL.onrender.com/api/version`
   - Verify environment variables are set correctly
   - Check logs for any startup errors

3. **Test Deploy Hooks**:
   - Manually trigger staging deploy hook via curl:
     ```bash
     curl -X POST RENDER_DEPLOY_HOOK_URL_STAGING
     ```
   - Verify deployment triggers in Render dashboard
   - Repeat for production deploy hook

### Step 8: Test Automated Deployment

1. **Test Staging Deployment**:
   - Push a change to `develop` branch
   - Verify `build.yml` workflow builds and pushes image
   - Verify `deploy-staging.yml` workflow triggers
   - Check Render dashboard for new deployment
   - Verify service health check passes

2. **Test Production Deployment**:
   - Merge code to `main` branch
   - Verify `build.yml` workflow builds and pushes image
   - Verify `deploy-production.yml` workflow triggers
   - Approve deployment in GitHub Actions (if approval required)
   - Check Render dashboard for new deployment
   - Verify service health check passes

## Files to Create/Modify

### New Files
- `.cursor/tasks/backend-deployment-infrastructure/006-render-setup-services/006-render-setup-services_plan.mdc` - This plan

### Files to Reference (No Changes)
- `.github/workflows/_deploy.yml` - Reusable deployment workflow
- `.github/workflows/deploy-staging.yml` - Staging deployment workflow
- `.github/workflows/deploy-production.yml` - Production deployment workflow
- `.github/workflows/build.yml` - Build workflow
- `backend/Dockerfile` - Docker image source
- `backend/DEPLOYMENT.md` - Deployment documentation

### Files to Update (Documentation)
- `backend/DEPLOYMENT.md` - Add Render service setup section with step-by-step instructions
- Update existing Render sections with actual configuration details

## Configuration Checklist

### Staging Service Checklist
- [ ] Render account created
- [ ] GitHub repository connected to Render
- [ ] GitHub PAT created with `read:packages` scope
- [ ] Staging service created in Render
- [ ] Docker image URL configured: `ghcr.io/USERNAME/kitchen-hub-api:develop-latest`
- [ ] GHCR credentials configured (username + PAT)
- [ ] Health check path set: `/api/version`
- [ ] Environment variables configured
- [ ] Deploy hook URL copied
- [ ] Auto-deploy disabled
- [ ] Service deployed successfully
- [ ] Health endpoint accessible: `/api/version`
- [ ] Deploy hook secret added to GitHub: `RENDER_DEPLOY_HOOK_URL_STAGING`

### Production Service Checklist
- [ ] Production service created in Render
- [ ] Docker image URL configured: `ghcr.io/USERNAME/kitchen-hub-api:main-latest`
- [ ] GHCR credentials configured (can reuse from staging)
- [ ] Health check path set: `/api/version`
- [ ] Environment variables configured (production values)
- [ ] Deploy hook URL copied
- [ ] Auto-deploy disabled
- [ ] Service deployed successfully
- [ ] Health endpoint accessible: `/api/version`
- [ ] Deploy hook secret added to GitHub: `RENDER_DEPLOY_HOOK_URL_PRODUCTION`

### GitHub Secrets Checklist
- [ ] `RENDER_DEPLOY_HOOK_URL_STAGING` added
- [ ] `RENDER_DEPLOY_HOOK_URL_PRODUCTION` added
- [ ] `STAGING_DATABASE_URL` added (optional, for migrations)
- [ ] `STAGING_DIRECT_URL` added (optional, for migrations)
- [ ] `PROD_DATABASE_URL` added (optional, for migrations)
- [ ] `PROD_DIRECT_URL` added (optional, for migrations)
- [ ] `STAGING_SERVICE_URL` added (optional, for health checks)
- [ ] `PRODUCTION_SERVICE_URL` added (optional, for health checks)

## Testing Strategy

### Manual Testing

1. **Service Creation**:
   - Verify services appear in Render dashboard
   - Verify service URLs are accessible
   - Test health endpoints return 200 OK

2. **Image Pull**:
   - Verify Render can pull images from GHCR
   - Check service logs for authentication errors
   - Verify correct image tag is being used

3. **Health Checks**:
   - Verify Render health checks pass
   - Test `/api/version` endpoint manually
   - Verify health check configuration in Render dashboard

4. **Deploy Hooks**:
   - Test deploy hooks via curl
   - Verify deployments trigger correctly
   - Check deployment logs in Render

5. **Automated Deployment**:
   - Push to `develop` branch and verify staging deployment
   - Merge to `main` branch and verify production deployment (with approval)
   - Verify health checks pass after deployment

### Validation Checklist

- [ ] Both services created and running
- [ ] GHCR image pull working correctly
- [ ] Health checks configured and passing
- [ ] Deploy hooks working
- [ ] GitHub secrets configured
- [ ] Environment variables set correctly
- [ ] Automated deployments working
- [ ] Documentation updated

## Success Criteria

1. ✅ Render account created and verified
2. ✅ GitHub repository connected to Render
3. ✅ Staging service created with correct configuration
4. ✅ Production service created with correct configuration
5. ✅ Both services pulling images from GHCR successfully
6. ✅ Health check path `/api/version` configured and working
7. ✅ Deploy hooks created and added to GitHub secrets
8. ✅ Environment variables configured for both services
9. ✅ Services deployed and running successfully
10. ✅ Automated deployments working via GitHub Actions
11. ✅ Documentation updated with Render setup instructions

## Considerations

### Render Free Tier Limitations

- **Sleep After Inactivity**: Free tier services sleep after 15 minutes of inactivity
- **Cold Start**: First request after sleep takes ~30 seconds
- **Resource Limits**: Limited CPU and memory
- **Recommendation**: Use Free tier for staging, paid tier for production

### GHCR Authentication

- **Public Images**: No authentication required
- **Private Images**: Require GitHub PAT with `read:packages` scope
- **Token Security**: Store PAT securely, rotate periodically
- **Credential Reuse**: Same PAT can be used for multiple services

### Health Check Configuration

- **Path**: `/api/version` (public endpoint, no auth required)
- **Interval**: 30 seconds (default)
- **Timeout**: 10 seconds (default)
- **Grace Period**: 40 seconds (allows app startup time)
- **Failure Threshold**: Service marked unhealthy after multiple failures

### Deploy Hook Security

- **URL Format**: `https://api.render.com/deploy/srv-xxx?key=yyy`
- **Access**: Anyone with URL can trigger deployment
- **Protection**: Store URLs as GitHub secrets, never commit to repo
- **Regeneration**: Can regenerate deploy hooks if compromised

### Environment Variables

- **Sensitive Data**: Never commit to repository
- **Render Dashboard**: Set via Render dashboard UI
- **Secrets Management**: Consider using Render's secret management features
- **Validation**: Ensure all required variables from `env.validation.ts` are set

### Service URLs

- **Format**: `https://SERVICE_NAME.onrender.com`
- **Custom Domains**: Can configure custom domains in Render
- **SSL**: Automatically provided by Render
- **Health Checks**: Use service URL + `/api/version` for health checks

### Image Tag Strategy

- **Staging**: `develop-latest` (always latest from develop branch)
- **Production**: `main-latest` (always latest from main branch)
- **Specific Deployments**: Can use `BRANCH-SHA` tags for specific commits
- **Rollback**: Deploy previous SHA tag via manual deployment

## Security Considerations

1. **GitHub PAT Security**:
   - Use minimal scopes (`read:packages` only)
   - Rotate tokens periodically
   - Never commit tokens to repository
   - Store in Render credential management

2. **Deploy Hook Security**:
   - Store URLs as GitHub secrets
   - Never expose in logs or documentation
   - Regenerate if compromised
   - Limit access to authorized personnel

3. **Environment Variables**:
   - Use different secrets for staging and production
   - Never commit secrets to repository
   - Use Render's secret management features
   - Rotate secrets periodically

4. **Service Access**:
   - Configure appropriate instance types
   - Use production-tier instances for production
   - Monitor service usage and costs
   - Set up alerts for service failures

## Future Enhancements

1. **Custom Domains**:
   - Configure custom domains for staging and production
   - Set up DNS records
   - Configure SSL certificates

2. **Monitoring and Alerts**:
   - Set up Render monitoring and alerts
   - Configure Slack/Discord notifications
   - Set up uptime monitoring

3. **Database Setup**:
   - Create Render PostgreSQL databases for staging and production
   - Configure database backups
   - Set up database connection pooling

4. **CI/CD Enhancements**:
   - Add deployment status notifications
   - Implement canary deployments
   - Add rollback capabilities

5. **Multi-Region Deployment**:
   - Deploy to multiple regions for redundancy
   - Configure load balancing
   - Set up failover mechanisms

## References

- Render Docker Image Deployment: https://render.com/docs/deploy-an-image
- Render Deploy Hooks: https://render.com/docs/deploy-hooks
- GitHub Container Registry: https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry
- Existing deployment workflows: `.github/workflows/_deploy.yml`, `.github/workflows/deploy-staging.yml`, `.github/workflows/deploy-production.yml`
- Deployment documentation: `backend/DEPLOYMENT.md`
- GHCR quick reference: `backend/docs/GHCR_QUICK_REFERENCE.md`
