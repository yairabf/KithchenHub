# 002 - Backend .dockerignore Enhancement

**Epic:** Backend Deployment Infrastructure  
**Created:** 2026-01-28  
**Status:** Completed

## Overview

Enhance the existing `backend/.dockerignore` file to include comprehensive exclusion patterns that are currently missing. The current `.dockerignore` has basic patterns but is missing several important exclusions that would optimize Docker build context size and speed up CI builds.

## Current Status

### What Already Exists

The `backend/.dockerignore` file was created in task `001-dockerfile-production-setup` and includes:

- ✅ Dependencies: `node_modules/`, npm/yarn debug logs
- ✅ Environment files: `.env*` (with exception for `.env.example`)
- ✅ Git and version control: `.git/`, `.gitignore`, `.github/`, `.gitlab-ci.yml`
- ✅ Build artifacts: `dist/`, `build/`, `coverage/`, `*.tsbuildinfo`
- ✅ Testing: `test/`, `*.spec.ts`, `jest.config.js`
- ✅ Documentation: `*.md` (except `README.md`), `docs/`
- ✅ Docker files: `Dockerfile*`, `.dockerignore`, `docker-compose*.yml`
- ✅ IDE files: `.vscode/`, `.idea/`, editor swap files
- ✅ NPM config: `.npmrc`
- ✅ Logs: `logs/`, `*.log`
- ✅ OS files: `.DS_Store`, `Thumbs.db`
- ✅ Temporary files: `tmp/`, `temp/`

### What's Missing

Based on comparison with `.gitignore` and Docker best practices, the following patterns are missing:

1. **Coverage artifacts** (present in `.gitignore` but not in `.dockerignore`):
   - `.nyc_output/` - NYC coverage output directory
   - `*.lcov` - LCOV coverage report files

2. **Jest cache** (present in `.gitignore` but not in `.dockerignore`):
   - `.jest/` - Jest cache directory

3. **Source maps** (generated during build, not needed in build context):
   - `*.map` - Source map files generated by TypeScript compiler

4. **Additional CI/CD files**:
   - `.travis.yml` - Travis CI configuration
   - `.circleci/` - CircleCI configuration directory
   - `.github/workflows/` - GitHub Actions workflows (already partially covered by `.github/` but explicit is better)

5. **Additional editor/IDE files**:
   - `.project`, `.classpath`, `.settings/` - Eclipse IDE files
   - `.sublime-*` - Sublime Text files

6. **Additional package manager lock files** (for consistency, even though project uses npm):
   - `yarn.lock` - Yarn lock file
   - `pnpm-lock.yaml` - pnpm lock file
   - `package-lock.json` should NOT be ignored (needed for `npm ci`)

7. **Additional log patterns**:
   - `lerna-debug.log*` - Lerna debug logs
   - More comprehensive log patterns

8. **Build configuration files** (not needed in Docker build):
   - `.prettierrc`, `.prettierrc.*` - Prettier config (formatting not needed in build)
   - `.eslintrc.js`, `.eslintrc.*` - ESLint config (linting not needed in build)
   - `.node-version` - Node version file (not needed, version specified in Dockerfile)

9. **Additional OS files**:
   - `*.swp`, `*.swo` - Already covered, but could add `*.swn` for completeness

## Architecture

### Files to Modify

- `backend/.dockerignore` - Enhance with missing exclusion patterns

### Files That Must NOT Be Ignored

The following files are required for the Docker build and must remain accessible:

- `package.json` - Required for `npm ci`
- `package-lock.json` - Required for `npm ci --frozen-lockfile`
- `tsconfig.json` - May be needed for TypeScript compilation
- `nest-cli.json` - NestJS build configuration
- `src/` - Source code directory (needed for build)
- `src/infrastructure/database/prisma/schema.prisma` - Required for Prisma Client generation
- `src/infrastructure/database/prisma/migrations/` - May be needed for production migrations

## Implementation Steps

### 1. Review Current .dockerignore ✅

Read the current `backend/.dockerignore` file to understand existing patterns and organization.

### 2. Add Missing Patterns ✅

Enhance the `.dockerignore` file with missing patterns, organized by category:

**Coverage & Testing:**
- `.nyc_output/`
- `*.lcov`
- `.jest/`

**Build Artifacts:**
- `*.map` (source maps)

**CI/CD:**
- `.travis.yml`
- `.circleci/`
- `.github/workflows/` (explicit, even though `.github/` is already there)

**Editor/IDE:**
- `.project`
- `.classpath`
- `.settings/`
- `.sublime-*`

**Package Managers:**
- `yarn.lock`
- `pnpm-lock.yaml`

**Logs:**
- `lerna-debug.log*`

**Config Files (not needed in build):**
- `.prettierrc*`
- `.eslintrc*`
- `.node-version`

**OS Files:**
- `*.swn` (additional vim swap file)

### 3. Organize and Comment ✅

Maintain clear organization with section comments to make the file maintainable and self-documenting.

### 4. Verify Patterns ✅

Ensure that:
- No required files are accidentally excluded
- Patterns follow Docker ignore syntax
- Comments explain any non-obvious exclusions

## Testing Strategy

### Manual Verification

1. **Check build context size:**
   ```bash
   cd backend
   docker build --no-cache -t test-build .
   # Compare build time and context size
   ```

2. **Verify required files are included:**
   - Check that `package.json`, `package-lock.json`, `tsconfig.json`, `nest-cli.json` are accessible
   - Verify `src/` directory is copied
   - Confirm Prisma schema is accessible

3. **Verify excluded files are not in context:**
   - Check that `node_modules/`, `dist/`, `.env`, `coverage/`, etc. are excluded
   - Verify test files and spec files are excluded
   - Confirm documentation files (except README.md) are excluded

### Expected Benefits

- **Reduced build context size**: Excluding unnecessary files reduces the amount of data sent to Docker daemon
- **Faster CI builds**: Smaller context means faster uploads and builds
- **Better security**: Ensures sensitive files (`.env`, `.npmrc`) are never accidentally included
- **Cleaner builds**: Prevents build artifacts from interfering with fresh builds

## Success Criteria

- ✅ `.dockerignore` includes all missing patterns from `.gitignore` that are relevant for Docker builds
- ✅ `.dockerignore` includes additional Docker-specific exclusions (source maps, build configs)
- ✅ File is well-organized with clear section comments
- ✅ All required files for build remain accessible
- ✅ Build context size is optimized
- ✅ No breaking changes to existing Docker build process

## Files Modified

1. `backend/.dockerignore` - Enhanced with comprehensive exclusion patterns

## Implementation Summary

### Changes Made

The `.dockerignore` file has been completely reorganized and enhanced with:

1. **Added missing coverage patterns:**
   - `.nyc_output/`
   - `*.lcov`

2. **Added Jest cache:**
   - `.jest/`

3. **Added source maps:**
   - `*.map`

4. **Added CI/CD files:**
   - `.travis.yml`
   - `.circleci/`
   - `.github/workflows/`

5. **Added editor/IDE files:**
   - `.project`, `.classpath`, `.settings/`
   - `.sublime-*`
   - `*.swn`

6. **Added package manager files:**
   - `yarn.lock`
   - `pnpm-lock.yaml`
   - `pnpm-debug.log`

7. **Added build configuration files:**
   - `.prettierrc*`
   - `.eslintrc*`
   - `.node-version`

8. **Added additional log patterns:**
   - `lerna-debug.log*`

9. **Organized with clear section comments:**
   - Each section has a clear header with separator lines
   - Added explanatory comment for package manager files section

### Verification

- ✅ All required files (`package.json`, `package-lock.json`, `tsconfig.json`, `nest-cli.json`, `src/`, Prisma schema) are NOT excluded
- ✅ All missing patterns from the plan have been added
- ✅ File is well-organized and maintainable
- ✅ No breaking changes to existing Docker build process

## Notes

- The `.dockerignore` file uses the same pattern syntax as `.gitignore`
- Patterns are evaluated relative to the build context (typically the directory containing the Dockerfile)
- Order matters - more specific patterns should come before general ones
- Negation patterns (`!`) can be used to include files that would otherwise be excluded
- The Dockerfile explicitly copies `src/infrastructure/database/prisma` for Prisma generation, so this must not be excluded

## References

- [Docker .dockerignore Documentation](https://docs.docker.com/engine/reference/builder/#dockerignore-file)
- [Docker Build Context Best Practices](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#exclude-with-dockerignore)
- Previous task: `001-dockerfile-production-setup` - Created initial `.dockerignore`
