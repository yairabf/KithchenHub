# 004 - Staging Deploy Workflow (develop → staging)

**Epic:** Backend Deployment Infrastructure  
**Created:** 2026-01-28  
**Status:** Planning

## Overview

Create a staging deployment workflow (`.github/workflows/deploy-staging.yml`) that automatically deploys to staging environment when code is merged to the `develop` branch. This workflow calls a reusable `_deploy.yml` workflow with `environment=staging` and `deploy_target=gcp-cloudrun`, establishing a cloud-agnostic deployment pattern that can be extended for other environments and deployment targets.

## Current Status Analysis

### Existing Infrastructure ✅

1. **Build Workflows**:
  - `build.yml` - Builds and pushes Docker images to GHCR for `develop` and `main` branches
  - `build-push.yml` - Builds and pushes Docker images to GHCR for all branches
  - Both workflows create images tagged with `BRANCH-SHA` and `BRANCH-latest` formats
2. **CI Workflow**:
  - `ci.yml` - Runs lint, typecheck, and unit tests on PRs
3. **Docker Infrastructure**:
  - Production-ready multi-stage Dockerfile exists
  - Images are automatically built and pushed to GHCR
  - Images available at `ghcr.io/${{ github.repository_owner }}/kitchen-hub-api:TAG`
4. **Deployment Documentation**:
  - `backend/DEPLOYMENT.md` documents GCP Cloud Run deployment process
  - Cloud Run is deployed directly from GitHub Actions via `gcloud run deploy`

### What's Missing ❌

1. **Reusable Deployment Workflow**: No `_deploy.yml` reusable workflow exists
2. **Staging Deployment Workflow**: No `deploy-staging.yml` workflow exists
3. **Deployment Automation**: No automated deployment process after builds complete
4. **Environment-Specific Configuration**: No environment-specific deployment logic
5. **Cloud-Agnostic Pattern**: No abstraction layer for different deployment targets

## Architecture

### Workflow Structure

The deployment infrastructure will consist of two workflows:

1. `**_deploy.yml**` (Reusable Workflow):
  - Cloud-agnostic deployment workflow
  - Accepts inputs: `environment`, `deploy_target`, `image_tag`
  - Supports multiple deployment targets (gcp-cloudrun, aws-ecs, etc.)
  - Handles deployment logic based on `deploy_target` input
2. `**deploy-staging.yml**` (Caller Workflow):
  - Triggers on pushes to `develop` branch
  - Calls `_deploy.yml` with `environment=staging` and `deploy_target=gcp-cloudrun`
  - Waits for build workflow to complete (if needed)
  - Handles staging-specific configuration

### Deployment Flow

```mermaid
graph LR
    A[Push to develop] --> B[build.yml triggers]
    B --> C[Build Docker image]
    C --> D[Push to GHCR]
    D --> E[deploy-staging.yml triggers]
    E --> F[Call _deploy.yml]
    F --> G{deploy_target?}
    G -->|gcp-cloudrun| H[Deploy to Cloud Run]
    G -->|aws-ecs| I[AWS ECS]
    H --> J[Staging Environment]
    I --> J
```

### Reusable Workflow Design (`_deploy.yml`)

**Inputs:**

- `environment` (required, string): Environment name (staging, production, etc.)
- `deploy_target` (required, string): Deployment target (gcp-cloudrun, aws-ecs, etc.)
- `image_tag` (optional, string): Docker image tag to deploy (defaults to `develop-latest` for staging)

**Jobs:**

- `deploy`: Handles deployment based on `deploy_target` input

**Deployment Target Logic:**

- **gcp-cloudrun**: Deploys to GCP Cloud Run via `gcloud run deploy` (uses GCP_PROJECT_ID, GCP_REGION, GCP_CLOUD_RUN_SERVICE, GCP_SA_KEY)
- **aws-ecs**: Uses AWS ECS deployment
- **other**: Extensible for additional targets

### Staging Workflow Design (`deploy-staging.yml`)

**Triggers:**

- `push` to `develop` branch
- Path filters: `backend/**` and `.github/workflows/deploy-staging.yml`

**Jobs:**

- `deploy_to_staging`: Calls `_deploy.yml` reusable workflow

**Configuration:**

- `environment`: `staging`
- `deploy_target`: `gcp-cloudrun`
- `image_tag`: `develop-latest` (matches build.yml tagging)

## Implementation Steps

### Step 1: Create Task Directory Structure

- Create `.cursor/tasks/backend-deployment-infrastructure/004-staging-deploy-workflow/`
- Create plan document: `004-staging-deploy-workflow_plan.mdc`

### Step 2: Create Reusable Deployment Workflow (`_deploy.yml`)

**Location:** `.github/workflows/_deploy.yml`

**Key Features:**

- `workflow_call` trigger with inputs
- Environment-specific job configuration
- Conditional deployment logic based on `deploy_target`
- GCP Cloud Run deployment via `gcloud run deploy`
- Extensible structure for future deployment targets

**Inputs Definition:**

```yaml
on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Deployment environment (staging, production, etc.)'
      deploy_target:
        required: true
        type: string
        description: 'Deployment target (gcp-cloudrun, aws-ecs, etc.)'
      image_tag:
        required: false
        type: string
        description: 'Docker image tag to deploy'
        default: ''
```

**GCP Cloud Run Deployment Implementation:**

- Use GCP secrets: GCP_PROJECT_ID, GCP_REGION, GCP_CLOUD_RUN_SERVICE (or GCP_CLOUD_RUN_SERVICE_STAGING for staging), GCP_SA_KEY
- Run `gcloud run deploy` with image from GHCR
- Support both staging and production via different Cloud Run service names

### Step 3: Create Staging Deployment Workflow (`deploy-staging.yml`)

**Location:** `.github/workflows/deploy-staging.yml`

**Key Features:**

- Triggers on `develop` branch pushes
- Path filters for backend changes
- Calls `_deploy.yml` with appropriate inputs
- Concurrency control to prevent duplicate deployments

**Workflow Call:**

```yaml
jobs:
  deploy_to_staging:
    uses: ./.github/workflows/_deploy.yml
    with:
      environment: staging
      deploy_target: gcp-cloudrun
      image_tag: develop-latest
    secrets: inherit
```

### Step 4: Configure Secrets

**Required GitHub Secrets (GCP Cloud Run):**

- `GCP_PROJECT_ID`: GCP project ID
- `GCP_REGION`: Cloud Run region (e.g. us-central1)
- `GCP_CLOUD_RUN_SERVICE_STAGING`: Staging Cloud Run service name
- `GCP_SA_KEY`: Service account JSON key for GitHub Actions

**Secret Setup Instructions:**

1. Complete GCP Cloud Run one-time setup (see backend/DEPLOYMENT.md)
2. Add secrets in GitHub: Settings → Secrets and variables → Actions → New repository secret

### Step 5: Add Concurrency Control

Both workflows should include concurrency control:

- `_deploy.yml`: Group by `deploy-${{ inputs.environment }}-${{ inputs.deploy_target }}`
- `deploy-staging.yml`: Group by `deploy-staging-${{ github.ref }}`

### Step 6: Add Error Handling

- Validate inputs in `_deploy.yml`
- Handle deployment failures gracefully
- Provide clear error messages
- Support retry logic (optional)

### Step 7: Documentation

- Update `backend/DEPLOYMENT.md` with staging deployment information
- Document secret setup process
- Add troubleshooting section for deployment issues

## Files to Create/Modify

### New Files

- `.github/workflows/_deploy.yml` - Reusable deployment workflow
- `.github/workflows/deploy-staging.yml` - Staging deployment workflow
- `.cursor/tasks/backend-deployment-infrastructure/004-staging-deploy-workflow/004-staging-deploy-workflow_plan.mdc` - This plan

### Files to Reference (No Changes)

- `.github/workflows/build.yml` - Build workflow that creates images
- `backend/DEPLOYMENT.md` - Deployment documentation
- `backend/Dockerfile` - Docker image source

### Files to Update (Documentation)

- `backend/DEPLOYMENT.md` - Add staging deployment section
- `backend/README.md` - Reference staging deployment workflow (optional)

## Testing Strategy

### Manual Testing

1. **Test Reusable Workflow**:
  - Create a test workflow that calls `_deploy.yml` with test inputs
  - Verify inputs are passed correctly
  - Verify deployment logic executes
2. **Test Staging Deployment**:
  - Push a change to `develop` branch
  - Verify `deploy-staging.yml` triggers
  - Verify it calls `_deploy.yml` with correct inputs
  - Verify Cloud Run deployment is triggered
  - Check GCP Cloud Run console for deployment status
3. **Test Error Handling**:
  - Test with invalid inputs
  - Test with missing secrets
  - Verify error messages are clear

### Validation Checklist

- `_deploy.yml` exists and is properly configured
- `deploy-staging.yml` exists and triggers on `develop` branch
- Workflow call syntax is correct
- Inputs are properly defined and used
- GCP Cloud Run deployment integration works
- Secrets are configured correctly
- Concurrency control prevents duplicate deployments
- Error handling provides clear feedback
- Documentation is updated

## Success Criteria

1. ✅ `.github/workflows/_deploy.yml` exists as reusable workflow
2. ✅ `.github/workflows/deploy-staging.yml` exists and triggers on `develop`
3. ✅ `deploy-staging.yml` calls `_deploy.yml` with `environment=staging` and `deploy_target=gcp-cloudrun`
4. ✅ GCP Cloud Run deployment completes successfully
5. ✅ Workflow is cloud-agnostic and extensible for other targets
6. ✅ Secrets are properly configured
7. ✅ Concurrency control prevents duplicate deployments
8. ✅ Documentation is updated with staging deployment process

## Considerations

### GCP Cloud Run Deployment

**Advantages:**

- Direct deploy from GitHub Actions via `gcloud run deploy`
- No deploy hook; workflow controls the full deploy
- Cloud Run scales to zero and supports GHCR images
- Works well for automated staging and production

**Implementation:**

- Use `google-github-actions/auth` and `setup-gcloud` with GCP_SA_KEY
- Run `gcloud run deploy` with image from GHCR
- Staging and production use different Cloud Run service names (e.g. GCP_CLOUD_RUN_SERVICE_STAGING vs GCP_CLOUD_RUN_SERVICE)

### Cloud-Agnostic Design

The `_deploy.yml` workflow is designed to support multiple deployment targets:

- **Current**: GCP Cloud Run (via gcloud run deploy)
- **Also supported**: AWS ECS
- **Future**: Railway (API), etc.

Each target can be added as a conditional step in the deploy job.

### Image Tag Strategy

- **Staging**: Uses `develop-latest` tag (always latest from develop branch)
- **Production**: Will use `main-latest` tag (when production workflow is created)
- **Specific deployments**: Can pass specific SHA tags for reproducible deployments

### Workflow Dependencies

**Option A: Sequential (Recommended)**

- `deploy-staging.yml` waits for `build.yml` to complete
- Uses `workflow_run` trigger or job dependencies
- Ensures image exists before deployment

**Option B: Independent**

- `deploy-staging.yml` triggers independently
- Assumes image already exists (from previous build)
- Simpler but less reliable

**Recommendation**: Start with Option B (independent), add dependency later if needed.

### Environment Variables

Cloud Run deployments require environment variables to be configured in Cloud Run (or Secret Manager):

- Database URLs
- JWT secrets
- Supabase credentials
- Other application secrets

These should NOT be passed through GitHub Actions workflows for security.

## Security Considerations

1. **Secrets Management**:
  - GCP service account key and Cloud Run config stored as GitHub secrets
  - Never expose secrets in logs
  - Use `secrets: inherit` for reusable workflows
2. **Deployment Permissions**:
  - Minimal permissions required
  - Only `contents: read` needed for workflow call
  - Secrets access controlled by repository settings
3. **Image Verification**:
  - Verify image exists in GHCR before deployment
  - Use specific tags for reproducible deployments
  - Avoid deploying untested images

## Future Enhancements

1. **Production Deployment Workflow**:
  - Create `deploy-production.yml` for `main` branch
  - Similar structure to staging workflow
  - Production-specific configuration
2. **Deployment Status Notifications**:
  - Slack/Discord notifications on deployment success/failure
  - Email notifications for production deployments
3. **Rollback Capability**:
  - Add ability to rollback to previous image version
  - Manual rollback workflow
4. **Multi-Target Support**:
  - Add Railway deployment support
  - Add AWS ECS deployment support
  - Add other cloud providers
5. **Deployment Verification**:
  - Health check after deployment
  - Smoke tests to verify deployment success
  - Automatic rollback on health check failure

## References

- Existing build workflow: [`.github/workflows/build.yml`](.github/workflows/build.yml)
- Deployment documentation: [`backend/DEPLOYMENT.md`](backend/DEPLOYMENT.md)
- GCP Cloud Run: [Cloud Run Documentation](https://cloud.google.com/run/docs)
- GitHub reusable workflows: [GitHub Actions Reusable Workflows](https://docs.github.com/en/actions/using-workflows/reusing-workflows)
